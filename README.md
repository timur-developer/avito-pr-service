# Сервис назначения Pull Request-ов

Тестовое задание для отбора на стажировку Авито

## Запуск приложения

**Требования:** установленный и запущенный Docker (https://www.docker.com/) и свободные порты: 5432 (для PostgreSQL), 8080 (само API), 8081 (Swagger)

1) Сделайте клон репозитория с помощью терминала:
```
git clone https://github.com/timur-developer/avito-pr-service
```
2) Перейдите в папку с проектом

3) Откройте терминал в папке с проектом

4) Запустите контейнеры:
    - При первом запуске используйте `docker-compose up --build` или `docker-compose up --build -d`
    - При последующих запусках `docker-compose up` или `docker-compose up -d`

   Это поднимет:
   - БД PostgreSQL на порту 5432
   - Миграции
   - Сам сервис на http://localhost:8080
   - Swagger UI на http://localhost:8081

## Swagger для тестов

Опционально добавил Swagger, можно быстро протестить сервис, не тыкая руками запросы. По эндпоинту /docs (http://localhost:8080/docs) находится swagger со всей документацией и возможностью сразу сделать запросы

## Завершение работы
Чтобы остановить сервис, используйте команду docker-compose down в терминале. Это корректно завершит работу всех контейнеров, включая БД и API. Сервис поддерживает graceful shutdown: при получении сигналов SIGINT/SIGTERM (например Ctrl C) он завершает работу с таймаутом в 5 секунд, закрывая соединения с БД и сервером.

## Что реализовано

**Основной функционал:**

Все из ТЗ: создание/получение команд, установка активности пользователей, создание PR с автоназначением до 2 ревьюверов (из команды автора, только активные, исключая автора). Merge идемпотентный, после него нельзя поменять ревьюеров. Переназначение на случайного активного из команды старого ревьювера.

**Валидация** по полям json-а, плюс доменная (нельзя назначать неактивных, проверка на MERGED при reassign и т.д.).

**Для БД** использую PostgreSQL, создал индексы для скорости, транзакции только где нужно для атомарности (create PR, merge, reassign).

**Логирую** информацию с помощью slog, пользователю возвращаются только коды ошибок (NOT_FOUND и т.д.).

**Тесты:** Полное покрытие >80%. Unit-тесты на usecase (бизнес-логика) и handlers, интеграционные на слой repository (с тестовой БД). Используйте `go test ./...` в папке с проектом для запуска тестов (опционально добавьте флаг -cover для вывода общего процента покрытия сервиса тестами).

**Архитектуру** разделил на слои (repo работает с БД, usecase с бизнесом логикой, handler с запросами)

Подтянул обычный линтер golangci-lint

## Дополнительные задания

**Статистика** (`/stats/users`): GET-эндпоинт, возвращает статистику по всем user-ам и их PR. Выводит всех пользователей (наглядно видно у кого есть PR, у кого нет).

**Массовая деактивация** (`/team/deactivate`): POST с {team_name}, деактивирует всех юзеров в команде и переназначает ревьюверов в открытых PR (на случайных активных из их команд). Возвращает кол-во деактивированных пользователей и переназначенных PR.

**Интеграционные/E2E тесты:** Интеграционные на repository на весь функционал.

**Линтер:** Добавил golangci-lint (используйте golangci-lint run для запуска)

**Нагрузочное тестирование:**

Провел с k6 нагрузочные тесты по всем основным ручкам, по времени и rps справился отлично, но процент 409 статусов кодов был многоват (как я понял это из-за логики самого сервиса т.к. мы не можем назначить больше 2х ревьюеров на один PR то в условиях большой нагрузки даже если у нас много PR и команды большие у нас так или иначе будет очень много ситуаций когда пользователь не подписан на этот PR/PR уже замерджен и т.д.), отсюда и большое колво 409-ых.

## Допущения и проблемы

Добавил от себя: если в команде повторяются ID юзеров или пытаешься добавить юзера с ID, который уже в базе, то ошибка.

Для `/users/getReview`: если юзер ID не существует, возвращаю 404, чтобы не отдавать пустой список (ведь пользователя вовсе нет)

При создании PR если в команде <2 активных (кроме автора) назначаю 0 или 1 (т.е. можно создавать PR без ревьюеров, я реализовал так, вроде как и в ТЗ это имеется в виду)

Если PR замержен то возвращаю его (не меняю и т.д.)


*Надеюсь, вам понравится сервис! Хорошего дня!*








